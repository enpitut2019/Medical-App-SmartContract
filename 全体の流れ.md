# 全体の流れ（暫定）

## 前提

### 社会実装
Blockchain×医療において、電子カルテなどやり尽くされてない部分の検討  
社会実装は考えていないが、導入するとすれば既存の受付業務と二重で行うことになる  
→診療内容や看護記録などは現行の仕組み（カルテなど）を参照する

### ERC20
ERC20→トークンの規格、スマートコントラクト上で扱いやすい  
Ethereumは価格変動があるから支払いには不向き
ERC20準拠のステーブルコイン（ペッグ通貨）を使う  
ドルペッグやユーロペッグであれば外国人も馴染みやすい  
テストでは自作のERC20Tokenを使う

### サーバー
サーバーを使う場合、サーバーが単一障害点になる

- - -
## 準備
端末ごとに暗号化用の共通鍵（AES256用）を生成しておく  
ブロックチェーン上に格納したデータは外部から見ることができるため  
個人情報に関わる部分は暗号化した状態で格納する

### 病院側
使用するERC20Tokenを選択  
→ 夏合宿では自作のERC20Tokenを自動選択

- - -
## 受付
### 患者側
氏名や年齢、性別、服用中の薬、アレルギー、手術歴、宗教などをアプリに入力  
→ 患者データを鍵（患者）で暗号化  
→ 暗号化済み患者データに対して、秘密鍵で署名  
→ 鍵（患者）、暗号化済み患者データ、署名をQRコードに

### 病院側
患者のスマホに表示されたQRコードを読み込む  
→ 暗号化用の鍵（患者）と患者データを取得

患者データを確認  
→ 問題がなければ暗号化済み患者データと鍵（患者）を鍵（病院）で暗号化  

患者のパスポートから旅券番号を確認し入力  
→ ExaminationContractをデプロイ

### 患者側
eventからExaminationContractのアドレスをキャッチ
→ キャッチできなかった場合は考慮しない

- - -
## 診療
### 病院側
診察を行った上で、医療費が高額になるような病気であれば事前に医療費概算の提示を行う  
提示によるスマートコントラクト上の強制力はない（あくまで記録として残す）  

### 患者側
ExaminationContractのアドレスにERC20Tokenを送金 

### 病院側
アドレスに送金された金額を確認して治療を開始
- - -
## 決済
### 病院側
明細をアプリに入力  
iPadの画面で患者側に明細を提示  
自由診療なのでディスカウント要求も発生しうる

明細が確定したら鍵（患者）で暗号化してスマートコントラクトに載せる  
→ 医療費（文字列にする）、暗号化済み明細をQRコードに

### 患者側
イベントから医療費、明細を受け取る
(キャッチできなかった場合、コールで登録された医療費、明細を受け取る）
画面で医療費、明細を最終確認したら確定ボタンを押す  
→ 医療費（文字列）と暗号化済み明細を連結した物に署名  
→ 署名をQRコードに  

### 病院側
QRコードを読み込む  
→ 患者の署名をスマートコントラクトに送る  
→ デポジットしたTokenが振り分けられる

### 共通
支払い状況の表示を確認

### 患者側
不足分のTokenをスマートコントラクトのアドレスに送金
- - -
## 診療一覧
### 病院側
時系列でのリスト表示(日時, 旅券番号, 氏名, 性別)  
旅券番号での検索

### 患者側
リスト
病院名、支払い額、明細などの表示
- - -
- - -
- - -
## TODO

### 保険会社（仮想）との連携
保険会社から送金→自動で患者に送金はGAS的に厳しい  
（どちらかが直接コントラクトのメソッドを呼ぶ必要がある）

- - -
## アイディア
かかったGASを取引ごとに表示するなど  
患者側アプリを閉じても同じ画面から始まる

- - -
## メモ

### 仮想通貨交換業者
ETH→ERC20の交換はスマートコントラクト内部で行っても仮想通貨交換業に該当  
→ 明らかに実装不可

### 仮想通貨カストディ業者
仮想通貨カストディ業務：仮想通貨の管理（ウォレット）
2020年上旬から規制強化→本人確認義務と分別管理義務  
→ グレーゾーン